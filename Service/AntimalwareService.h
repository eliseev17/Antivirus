#pragma once
#include <windows.h>
#include "Service.h"
#include "IPC.h"
#include "Scanner.h"
#include "ScheduledScanner.h"
#include "InformationStorage.h"
#include "Monitoring.h"
#include <thread>
#include <memory>
#include "FilesWorker.h"
#include "InformationStorage.h"

#define BUFSIZE 2048
#define PIPE_BUFSIZE 1024

namespace Antimalware::ServiceApp
{
    class AntimalwareService : public ServiceLib::ServiceManagement::Service
    {
    public:
        AntimalwareService()
            : ServiceLib::ServiceManagement::Service(u"AntimalwareService")
        { }
        int clientMessagesProcessing();
        void processingMessage(message newMessage, HANDLE tempPipeFirst, HANDLE tempPipeSecond);
        void listenPipe(HANDLE tempPipeFirst, HANDLE tempPipeSecond);
        HANDLE pipeClientToService = INVALID_HANDLE_VALUE, pipeServiceToClient = NULL;
    private:
        std::shared_ptr <InformationStorage> infoStorage;
        // Флаг, показывающий, есть ли соединение
        BOOL   fConnected = FALSE;
    protected:
        virtual int Init() override;
        virtual void DoWork() override;
        virtual int DoStop() override;

    };

    class AntimalwareServiceFactory : public ServiceLib::ServiceManagement::IServiceFactory
    {
    public:
        AntimalwareServiceFactory();

        virtual std::unique_ptr<ServiceLib::ServiceManagement::Service> Create() override;

    private:
    };
}
